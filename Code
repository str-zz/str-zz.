## This is the code for the webapp! 
It uses three different languages: HTML (HyperText Markup Language), CSS (Cascading Style Sheets), and JavaScript



<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dosage Estimator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load TensorFlow.js library (The simplest prerequisite for in-browser ML) -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.2.0/dist/tf.min.js"></script>

    <!-- Configure Tailwind to use Inter font and simple theming -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#10568B',
                        'secondary-gray': '#F3F4F6',
                        'success-green': '#059669',
                        'info-yellow': '#F59E0B',
                        'ml-purple': '#8B5CF6', /* New color for ML result */
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for a cleaner UI */
        body {
            background-color: #E5E7EB; /* Light gray background */
        }
    </style>
</head>
<body class="font-sans min-h-screen flex items-center justify-center p-4">

    <!-- Main Calculation Card -->
    <div class="bg-white shadow-2xl rounded-xl p-6 md:p-10 w-full max-w-xl border-t-8 border-primary-blue">
        <h1 class="text-3xl font-bold text-primary-blue mb-2 text-center">Advanced Dosage Estimator (ML Demo)</h1>
        <p class="text-gray-500 text-center mb-8">Incorporates standard formulas and a simulated ML prediction.</p>

        <!-- Input Form -->
        <div class="space-y-6">

            <!-- Drug and Age Inputs -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="drugName" class="block text-sm font-medium text-gray-700 mb-1">Drug Name (Context)</label>
                    <input type="text" id="drugName" placeholder="e.g., Amoxicillin" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue transition duration-150">
                </div>
                <div>
                    <label for="patientAge" class="block text-sm font-medium text-gray-700 mb-1">Age (Years)</label>
                    <input type="number" id="patientAge" min="0" placeholder="e.g., 35" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue transition duration-150">
                </div>
            </div>

            <!-- Weight Input (kg/lbs) -->
            <div>
                <label for="weightInput" class="block text-sm font-medium text-gray-700 mb-1">Patient Weight</label>
                <div class="flex rounded-lg shadow-sm">
                    <input type="number" id="weightInput" step="0.1" min="0.1" placeholder="Enter weight value" class="flex-grow px-4 py-2 border border-gray-300 rounded-l-lg focus:ring-primary-blue focus:border-primary-blue transition duration-150">
                    <select id="weightUnit" class="border border-gray-300 border-l-0 rounded-r-lg bg-gray-50 text-gray-700 p-2 cursor-pointer transition duration-150 hover:bg-gray-100" onchange="calculateDose()">
                        <option value="kg">kg</option>
                        <option value="lbs">lbs</option>
                    </select>
                </div>
            </div>
            
            <!-- Height Input (cm/in) -->
            <div>
                <label for="heightInput" class="block text-sm font-medium text-gray-700 mb-1">Patient Height</label>
                <div class="flex rounded-lg shadow-sm">
                    <input type="number" id="heightInput" step="1" min="1" placeholder="Enter height value" class="flex-grow px-4 py-2 border border-gray-300 rounded-l-lg focus:ring-primary-blue focus:border-primary-blue transition duration-150">
                    <select id="heightUnit" class="border border-gray-300 border-l-0 rounded-r-lg bg-gray-50 text-gray-700 p-2 cursor-pointer transition duration-150 hover:bg-gray-100" onchange="calculateDose()">
                        <option value="cm">cm</option>
                        <option value="in">in</option>
                    </select>
                </div>
            </div>

            <!-- Dosing Factor and Frequency Inputs -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="dosingFactor" class="block text-sm font-medium text-gray-700 mb-1">Dosing Factor (mg/kg/day)</label>
                    <input type="number" id="dosingFactor" step="0.1" min="0.1" placeholder="e.g., 20" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue transition duration-150">
                    <p class="text-xs text-gray-500 mt-1">mg per kg of body weight per day.</p>
                </div>
                <div>
                    <label for="dosingFrequency" class="block text-sm font-medium text-gray-700 mb-1">Dosing Frequency (Times/Day)</label>
                    <input type="number" id="dosingFrequency" step="1" min="1" max="6" placeholder="e.g., 3" value="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue transition duration-150">
                    <p class="text-xs text-gray-500 mt-1">How many times per day (e.g., 1, 2, 3).</p>
                </div>
            </div>

            <!-- Calculate Button -->
            <button onclick="calculateDose()" class="w-full bg-primary-blue text-white py-3 rounded-lg font-semibold hover:bg-opacity-90 transition duration-300 shadow-md">
                Calculate Dose Estimates
            </button>
        </div>

        <!-- Result Section -->
        <div id="resultContainer" class="mt-8 pt-6 border-t border-gray-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Dose Estimates</h2>
            
            <!-- Result Display -->
            <div id="doseResult" class="bg-secondary-gray p-6 rounded-lg hidden">
                
                <!-- NEW Key Results: ML Adjusted Dose Range -->
                <div class="text-center mb-6 border-b pb-4 border-gray-300">
                    <p class="text-sm text-gray-600 mb-1 font-medium text-ml-purple">ML Adjusted Total Daily Dose (Range):</p>
                    <p class="text-4xl font-extrabold text-ml-purple" id="mlDoseOutput">0 - 0 mg</p>
                    <p class="text-xs text-gray-500 mt-1">The total dose after the simulated ML refinement, plus/minus the error margin.</p>
                </div>

                <!-- NEW ML Confidence Score Display -->
                <div class="text-center mb-6 pb-4 border-gray-300">
                    <p class="text-sm text-gray-600 mb-1 font-medium text-info-yellow">ML Confidence Score:</p>
                    <p class="text-3xl font-extrabold text-info-yellow" id="mlConfidenceOutput">0%</p>
                    <p class="text-xs text-gray-500 mt-1">Simulated confidence based on input values' proximity to ideal ranges.</p>
                </div>

                <!-- Dose Per Administration -->
                <div class="text-center mb-6 border-b pb-4 border-gray-300">
                    <p class="text-sm text-gray-600 mb-1 font-medium" id="adminDoseLabel">Dose Per Administration (TID):</p>
                    <p class="text-4xl font-extrabold text-success-green" id="adminDoseOutput">0 mg</p>
                </div>

                <!-- Secondary Results: TDD and BSA -->
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-primary-blue/20">
                        <p class="text-xs font-semibold text-primary-blue uppercase">Standard Total Daily Dose</p>
                        <p class="text-2xl font-bold text-primary-blue mt-1" id="dailyDoseOutput">0 mg</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-info-yellow/20">
                        <p class="text-xs font-semibold text-info-yellow uppercase">Body Surface Area (BSA)</p>
                        <p class="text-2xl font-bold text-info-yellow mt-1" id="bsaOutput">0.00 m²</p>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg hidden">
                <p class="font-medium">Calculation Error:</p>
                <p id="errorText" class="text-sm">Please ensure all numeric fields are valid and greater than zero.</p>
            </div>

            <!-- Disclaimer -->
            <p class="text-xs text-gray-500 mt-4 italic text-center" id="disclaimer">
                Disclaimer: This ML feature is a **simulation** for demonstration purposes and should **never** be used for actual medical decisions.
            </p>
        </div>

    </div>

    <script>
        // Global utility function for fetching element values
        const getVal = (id) => document.getElementById(id).value;
        const setHtml = (id, html) => document.getElementById(id).innerHTML = html;
        const show = (id) => document.getElementById(id).classList.remove('hidden');
        const hide = (id) => document.getElementById(id).classList.add('hidden');

        let dosageModel = null;

        /**
         * Initializes a simulated linear regression model using TensorFlow.js.
         * This model takes normalized Age and Weight as input and outputs a dose adjustment factor.
         */
        function initTfModel() {
            try {
                // 1. Define a simple sequential model
                dosageModel = tf.sequential();
                
                // Input layer: two features (Normalized Weight, Normalized Age)
                dosageModel.add(tf.layers.dense({ units: 1, inputShape: [2] }));

                // 2. Compile the model (Optimizer and Loss function are required for training, but we just need inference here)
                dosageModel.compile({ 
                    optimizer: tf.train.adam(0.01), 
                    loss: 'meanSquaredError' 
                });

                // 3. Set custom weights to simulate a trained model.
                // These weights will create a linear relationship: Output = (W1 * Weight) + (W2 * Age) + Bias
                const weights = [
                    tf.tensor2d([[-5], [10]]), // W1 (Weight influence: negative), W2 (Age influence: positive)
                    tf.tensor1d([10]) // Bias
                ];
                dosageModel.setWeights(weights);

                console.log('TensorFlow Model Initialized.');
            } catch (error) {
                console.error('Error initializing TensorFlow model:', error);
                // Fallback: continue without ML prediction
                dosageModel = 'error';
                // Update new UI elements with error state
                setHtml('mlDoseOutput', 'ML Model Failed to Load.');
                setHtml('mlConfidenceOutput', 'N/A');
            }
        }

        /**
         * Calculates a normalized deviation (0 to 1) for an input value against an ideal range.
         * @param {number} value The input number (e.g., weight)
         * @param {number} min The ideal minimum
         * @param {number} max The ideal maximum
         * @returns {number} Deviation score (0 for ideal, 1 for maximum deviation)
         */
        const getDeviation = (value, min, max) => {
            if (value >= min && value <= max) return 0;

            const mid = (min + max) / 2;
            let distance;
            if (value < mid) {
                distance = min - value;
            } else {
                distance = value - max;
            }
            
            // Normalize deviation based on distance outside the range
            // Max distance (e.g., 50 units outside) = 1.0 deviation
            return Math.min(1, Math.max(0, distance / 50)); 
        };

        async function calculateDose() {
            // 1. Get Inputs
            const weightInput = getVal('weightInput');
            const weightUnit = getVal('weightUnit');
            const heightInput = getVal('heightInput');
            const heightUnit = getVal('heightUnit');
            const dosingFactorInput = getVal('dosingFactor');
            const frequencyInput = getVal('dosingFrequency');
            const ageInput = getVal('patientAge');

            // 2. Input Validation & Parsing
            const weight = parseFloat(weightInput);
            const height = parseFloat(heightInput);
            const factor = parseFloat(dosingFactorInput);
            const freq = parseInt(frequencyInput);
            const age = parseInt(ageInput);


            if (isNaN(weight) || isNaN(factor) || isNaN(freq) || weight <= 0 || factor <= 0 || freq <= 0 || isNaN(age) || height <= 0) {
                hide('doseResult');
                show('errorMessage');
                return;
            }
            // Hide error message if valid
            hide('errorMessage');
            
            // 3. Unit Conversion (Standardize to kg and cm for formulas)
            let weightInKg = weight;
            if (weightUnit === 'lbs') {
                // 1 lb = 0.453592 kg
                weightInKg = weight * 0.453592;
            }

            let heightInCm = height;
            if (heightUnit === 'in') {
                // 1 in = 2.54 cm
                heightInCm = height * 2.54;
            }

            // 4. Core Calculations (Formulaic)
            // A. Standard Total Daily Dose (TDD) (Weight-Based)
            const totalDailyDose = weightInKg * factor;
            
            // B. Body Surface Area (BSA) (Mosteller Formula)
            let bsa = 0;
            if (weightInKg > 0 && heightInCm > 0) {
                 bsa = Math.sqrt((weightInKg * heightInCm) / 3600);
            }

            // 5. ML Model Prediction and Confidence/Range Simulation
            let adjustedTDD = totalDailyDose;
            let errorMargin = 0; // Initialize error margin

            // --- Confidence/Accuracy Simulation ---
            // Define assumed ideal data ranges for lowest error
            const idealWeightMin = 50; // kg
            const idealWeightMax = 100; // kg
            const idealAgeMin = 20; // years
            const idealAgeMax = 60; // years
            const idealFactorMin = 10; // mg/kg/day
            const idealFactorMax = 30; // mg/kg/day

            // Max possible error margin (20% of the dose)
            const maxErrorPercent = 0.20; 
            // Base error margin for ideal inputs (5% of the dose)
            const baseErrorPercent = 0.05; 
            
            // Calculate deviation for each key input
            const weightDeviation = getDeviation(weightInKg, idealWeightMin, idealWeightMax);
            const ageDeviation = getDeviation(age, idealAgeMin, idealAgeMax);
            const factorDeviation = getDeviation(factor, idealFactorMin, idealFactorMax);

            // Combine deviations (using weighted average: 40% weight, 30% age, 30% factor)
            const totalDeviation = (weightDeviation * 0.4) + (ageDeviation * 0.3) + (factorDeviation * 0.3);
            
            // Calculate error margin: starts at base and increases with deviation
            errorMargin = baseErrorPercent + (maxErrorPercent - baseErrorPercent) * totalDeviation; 
            // Clamp margin between 5% and 20%
            errorMargin = Math.max(baseErrorPercent, Math.min(maxErrorPercent, errorMargin)); 
            
            // Run ML Prediction
            if (dosageModel && dosageModel !== 'error') {
                // Prepare input tensor: normalize inputs for stable ML performance
                const normalizedWeight = weightInKg / 150; // Max weight assumed 150kg
                const normalizedAge = age / 100; // Max age assumed 100 years

                tf.tidy(() => {
                    const inputTensor = tf.tensor2d([[normalizedWeight, normalizedAge]]);
                    const predictionTensor = dosageModel.predict(inputTensor);
                    
                    // Get the prediction value
                    const adjustmentFactor = predictionTensor.dataSync()[0];

                    // Apply the factor: ML output * 10 is the adjustment amount in mg
                    adjustedTDD = totalDailyDose + (adjustmentFactor * 10); 
                });
            } else if (!dosageModel) {
                // Initial state while model is loading
                setHtml('mlDoseOutput', 'Loading ML Model...');
                setHtml('mlConfidenceOutput', '...');
            }

            // --- Range Calculation based on ML Adjusted TDD and Error Margin ---
            const errorAmount = adjustedTDD * errorMargin;
            const lowerBound = adjustedTDD - errorAmount;
            const upperBound = adjustedTDD + errorAmount;

            // D. Dose Per Administration (Uses the midpoint/adjustedTDD)
            const dosePerAdmin = adjustedTDD / freq;


            // 6. Output Formatting & Display
            
            const roundedTDD = totalDailyDose.toFixed(1);
            const roundedAdminDose = dosePerAdmin.toFixed(1);
            const roundedBSA = bsa.toFixed(2);
            
            // Format the range output
            const rangeOutput = `${lowerBound.toFixed(1)} - ${upperBound.toFixed(1)} mg`;

            // Calculate confidence (1 - errorMargin)
            const confidenceScore = ((1 - errorMargin) * 100).toFixed(0);
            
            // Update labels based on frequency
            const freqText = freq === 1 ? 'Daily' : `${freq} Times Per Day`;
            document.getElementById('adminDoseLabel').textContent = `Dose Per Administration (${freqText}):`;


            setHtml('dailyDoseOutput', `${roundedTDD} mg`);
            setHtml('adminDoseOutput', `${roundedAdminDose} mg`);
            setHtml('bsaOutput', `${roundedBSA} m²`);
            setHtml('mlDoseOutput', rangeOutput);
            setHtml('mlConfidenceOutput', `${confidenceScore}%`);

            show('doseResult');
        }

        // Initialize model and inputs on page load
        document.addEventListener('DOMContentLoaded', () => {
            initTfModel(); // Initialize the TensorFlow model
            
            // Placeholder values for demonstration (High Confidence Example)
            document.getElementById('drugName').value = 'ML Test Drug';
            document.getElementById('patientAge').value = 45; // Ideal range
            document.getElementById('weightInput').value = 75; // Ideal range
            document.getElementById('dosingFactor').value = 20; // Ideal range
            document.getElementById('heightInput').value = 175;
            document.getElementById('dosingFrequency').value = 2;
            
            // Calculate the initial dose
            calculateDose();
        });
        
        // Add event listeners to trigger calculation on input change
        document.querySelectorAll('input, select').forEach(element => {
            // Ensure we only add listeners to elements that exist and have relevant IDs
            if (element.id && (element.id !== 'drugName')) {
                element.addEventListener('input', calculateDose);
                element.addEventListener('change', calculateDose);
            }
        });
    </script>
</body>
</html>
